name: Generate Celenium API Go

on:
  repository_dispatch:
    types: [tag_created]

jobs:
  triggered_job:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Cleanup old client
        run: rm -rf celenium-api-go/

      - name: Install Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'

      - name: Download OpenAPI Generator CLI
        run: |
          wget https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/6.2.0/openapi-generator-cli-6.2.0.jar -O openapi-generator-cli.jar

      - name: Generate API client
        run: |
          java -jar openapi-generator-cli.jar generate \
            -i https://raw.githubusercontent.com/mismirnov/celestia-indexer/${{ github.event.client_payload.tag }}/cmd/api/docs/swagger.json \
            -g go \
            -o ./celenium-api-go \
            -p packageName=celenium --skip-validate-spec
          
      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"

      - name: Commit and push changes
        env:
          PAT_TOKEN: ${{ secrets.PAT }}
        run: |
          git add .
          git commit -m "${{ github.event.client_payload.tag }}"
          git push https://x-access-token:${PAT_TOKEN}@github.com/${{ github.repository }}.git